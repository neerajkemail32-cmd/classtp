<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Manage Fees | Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-4">Manage Fees</h2>

    <!-- Search Student -->
    <div class="mb-4">
      <h5>Search Student</h5>
      <div class="input-group">
        <input type="number" class="form-control" id="feesSearch" placeholder="Enter Student ID">
        <button class="btn btn-primary" onclick="searchFees()">Search</button>
      </div>
    </div>

    <!-- Student Info -->
    <div id="studentInfo" class="mb-3" style="display:none;">
      <h5>Student Info</h5>
      <p><strong>Name:</strong> <span id="sName"></span></p>
      <p><strong>Email:</strong> <span id="sEmail"></span></p>
      <p><strong>Batch:</strong> <span id="sBatch"></span></p>
    </div>

    <!-- Fees Table -->
    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Batch</th>
          <th>Amount</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="feesList">
        <tr><td colspan="5" class="text-center">Search for a student...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    let currentStudent = null;

    // Search student by ID
    function searchFees() {
      const studentId = document.getElementById('feesSearch').value.trim();
      if (!studentId) {
        alert('Enter Student ID first!');
        return;
      }

      fetch(`/students/${studentId}`)
        .then(res => {
          if (!res.ok) throw new Error('Student not found');
          return res.json();
        })
        .then(student => {
          currentStudent = student;

          // Show student info
          document.getElementById('studentInfo').style.display = 'block';
          document.getElementById('sName').innerText = student.fullName;
          document.getElementById('sEmail').innerText = student.email;
          document.getElementById('sBatch').innerText = student.batch;

          loadFees(student.id);
        })
        .catch(err => {
          alert(err.message);
          document.getElementById('studentInfo').style.display = 'none';
          document.getElementById('feesList').innerHTML =
            '<tr><td colspan="5" class="text-center">Student not found</td></tr>';
        });
    }

    // Load fees for student
    function loadFees(studentId) {
      fetch(`/fees/student/${studentId}`)
        .then(res => res.json())
        .then(fees => {
          let html = '';
          if (fees.length === 0) {
            html = '<tr><td colspan="5" class="text-center">No fees found</td></tr>';
          } else {
            fees.forEach(fee => {
              html += `
                <tr>
                  <td>${fee.id}</td>
                  <td>${fee.batch}</td>
                  <td>${fee.amount}</td>
                  <td>
                    <select onchange="updateFeeStatus(${fee.id}, this.value)" class="form-select">
                      <option value="Pending" ${fee.status === 'Pending' ? 'selected' : ''}>Pending</option>
                      <option value="Paid" ${fee.status === 'Paid' ? 'selected' : ''}>Paid</option>
                    </select>
                  </td>
                  <td>
                    <button class="btn btn-danger btn-sm" onclick="deleteFee(${fee.id})">Delete</button>
                  </td>
                </tr>
              `;
            });
          }
          document.getElementById('feesList').innerHTML = html;
        });
    }

    // Update fee status
    function updateFeeStatus(feeId, newStatus) {
      fetch(`/fees/${feeId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
      })
      .then(res => {
        if (!res.ok) throw new Error('Failed to update');
        return res.text();
      })
      .then(msg => alert(msg))
      .catch(err => alert(err.message));
    }

    // Delete fee
    function deleteFee(feeId) {
      if (!confirm('Are you sure you want to delete this fee record?')) return;

      fetch(`/fees/${feeId}`, { method: 'DELETE' })
        .then(res => res.text())
        .then(msg => {
          alert(msg);
          if (currentStudent) loadFees(currentStudent.id);
        });
    }
  </script>
</body>
</html>
